name: Build Cloud Ladder BE

on:
  workflow_dispatch:
    inputs:
      sha:
        description: 'sha'
        required: true
        type: string
      docker_registry:
        description: 'docker_registry'
        required: true
        type: string
      docker_registry_name:
        description: 'docker_registry_name'
        required: true
        type: string
      docker_registry_password:
        description: 'docker_registry_password'
        required: true
        type: string
      docker_image_name:
        description: 'docker_image_name'
        required: true
        type: string

env:
  IMAGE_NAME: ${{inputs.docker_image_name}}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          repository: lowcode-yunti/cloudladder-be
          ref: ${{inputs.sha}}
          token: ${{ secrets.CLOUD_LADDER_DISPATCH }}

      - name: Build with Maven
        run: mvn clean package -DskipTests
        working-directory: ./server/api-service

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17' # Specify the JDK version
          distribution: 'temurin' # Use Eclipse Temurin distribution

      - name: Set up Maven
        run: |
          mkdir -p ~/.m2
          echo "<settings><servers><server><id>github</id><username>${{ inputs.docker_registry_name }}</username><password>${{ inputs.docker_registry_password }}</password></server></servers></settings>" > ~/.m2/settings.xml

      - name: Build with Maven
        run: mvn clean package -DskipTests # Add any other Maven flags you require

      - name: Login to Docker Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ inputs.docker_registry }}
          username: ${{ inputs.docker_registry_name }}
          password: ${{ inputs.docker_registry_password }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('**/Dockerfile') }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4.1.1
        with:
          context: .
          file: deploy/docker/Dockerfile
          push: true
          tags: ${{inputs.docker_registry}}/${{env.IMAGE_NAME}}:${{ inputs.sha }},${{inputs.docker_registry}}/${{env.IMAGE_NAME}}:latest
          build-args: |
            DOCKER_BUILDKIT=1
          target: lowcoder-ce-api-service
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new
          load: false
          labels: ${{ steps.meta.outputs.labels }}
          platform: linux/amd64,linux/arm64,linux/arm/v7


      - name: Update cache
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache-new
          key: ${{ runner.os }}-buildx-${{ hashFiles('**/Dockerfile') }}
